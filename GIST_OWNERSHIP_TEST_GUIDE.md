# Gist 拥有者验证测试指南

## 概述

这个测试页面用于验证从访问者模式切换到拥有者模式时的 Gist 拥有者验证功能。

## 访问测试页面

在开发环境中访问：
```
http://localhost:5173/gist-ownership-test
```

## 测试准备

### 1. 准备测试数据

你需要准备以下数据：

- **你自己的 GitHub Token**：用于验证你的身份
- **你自己的 Gist ID**：你创建的 Gist（用于测试拥有者场景）
- **别人的 Gist ID**（可选）：通过分享链接获得的 Gist（用于测试非拥有者场景）

### 2. 快速加载当前数据

点击"从当前会话加载 Token 和 Gist ID"按钮，可以自动加载当前 authService 中保存的数据。

## 测试场景

### 场景 1：验证 Token 有效性

**目的**：确保 Token 验证功能正常工作

**步骤**：
1. 输入你的 GitHub Token
2. 点击"测试 1: 验证 Token"按钮
3. 查看结果

**预期结果**：
- ✅ Token 验证成功
- 显示你的 GitHub 用户名和头像 URL

**失败情况**：
- ❌ Token 无效或已过期
- ❌ 网络连接失败

---

### 场景 2：验证 Gist 拥有者（你是拥有者）

**目的**：验证当用户是 Gist 拥有者时的正常流程

**步骤**：
1. 输入你的 GitHub Token
2. 输入你自己创建的 Gist ID
3. 点击"测试 2: 验证拥有者"按钮
4. 查看结果

**预期结果**：
- ✅ 你是 Gist 的拥有者
- 显示拥有者用户名（应该是你的用户名）

**这意味着**：在实际应用中，你可以成功切换到拥有者模式

---

### 场景 3：验证 Gist 拥有者（你不是拥有者）

**目的**：验证安全机制，防止非拥有者获得编辑权限

**步骤**：
1. 输入你的 GitHub Token
2. 输入别人的 Gist ID（通过分享链接获得）
3. 点击"测试 2: 验证拥有者"按钮
4. 查看结果

**预期结果**：
- ❌ 你不是 Gist 的拥有者
- 显示真实拥有者的用户名
- 显示错误消息

**这意味着**：在实际应用中，你无法切换到拥有者模式，系统会阻止你进行编辑操作

---

### 场景 4：获取 Gist 数据

**目的**：验证 Gist 数据读取功能

**步骤**：
1. 输入 GitHub Token
2. 输入 Gist ID（你的或别人的都可以，只要是公开的）
3. 点击"测试 3: 获取 Gist"按钮
4. 查看结果

**预期结果**：
- ✅ Gist 数据获取成功
- 显示资源数量、问题数量、最后同步时间等信息

**注意**：即使你不是拥有者，也可以读取公开的 Gist 数据（这是访客模式的基础）

---

### 场景 5：完整的模式切换流程模拟

**目的**：模拟实际的模式切换流程，验证所有步骤

**步骤**：
1. 输入 GitHub Token
2. 输入 Gist ID（或留空）
3. 点击"测试 4: 完整流程"按钮
4. 查看每个步骤的结果

**流程说明**：

#### 子场景 5.1：有 Gist ID 且是拥有者
```
步骤 1: 验证 Token ✅
步骤 2: 验证 Gist 拥有者 ✅
步骤 3: 等待用户确认
结果: ✅ 可以切换到拥有者模式
```

#### 子场景 5.2：有 Gist ID 但不是拥有者
```
步骤 1: 验证 Token ✅
步骤 2: 验证 Gist 拥有者 ❌
结果: ❌ 无法切换到拥有者模式
```

#### 子场景 5.3：没有 Gist ID
```
步骤 1: 验证 Token ✅
步骤 2: 跳过拥有者验证（没有 Gist ID）
结果: ✅ 可以切换到拥有者模式（用户可能要创建新 Gist）
```

#### 子场景 5.4：Token 无效
```
步骤 1: 验证 Token ❌
结果: ❌ 无法切换到拥有者模式
```

---

## 测试结果解读

### 成功标志（绿色）
- ✅ 表示该步骤通过
- 显示详细信息（用户名、拥有者等）

### 失败标志（红色）
- ❌ 表示该步骤失败
- 显示错误原因
- 显示详细信息（如真实拥有者的用户名）

## 实际应用场景

### 场景 A：网站拥有者首次使用
1. 用户访问网站（默认访客模式）
2. 点击模式指示器，选择"拥有者模式"
3. 输入 GitHub Token
4. 系统验证 Token ✅
5. 没有 Gist ID，跳过拥有者验证
6. 显示确认对话框
7. 用户确认 → 切换到拥有者模式 ✅

### 场景 B：网站拥有者返回访问
1. 用户访问网站（系统自动恢复拥有者模式）
2. 用户点击模式指示器，切换到访客模式
3. 稍后想切回拥有者模式
4. 点击模式指示器，选择"拥有者模式"
5. 系统验证 Token ✅
6. 系统验证 Gist 拥有者 ✅（用户是拥有者）
7. 显示确认对话框
8. 用户确认 → 切换到拥有者模式 ✅

### 场景 C：访客通过分享链接访问
1. 用户通过分享链接访问（URL 包含 Gist ID）
2. 系统加载 Gist 数据，显示内容（访客模式）
3. 用户想切换到拥有者模式进行编辑
4. 点击模式指示器，选择"拥有者模式"
5. 输入自己的 GitHub Token
6. 系统验证 Token ✅
7. 系统验证 Gist 拥有者 ❌（用户不是拥有者）
8. 显示错误："你不是当前 Gist 的拥有者（拥有者：xxx），无法切换到拥有者模式"
9. 保持访客模式 ❌

**这是关键的安全机制**：防止访客误以为可以编辑别人的内容。

## 常见问题

### Q1: 为什么没有 Gist ID 时可以切换到拥有者模式？

**A**: 因为用户可能是第一次使用，还没有创建 Gist。允许切换到拥有者模式后，用户可以创建新的 Gist 并开始编辑。

### Q2: 如果我有有效的 Token，但 Gist 是别人的，会发生什么？

**A**: 系统会阻止你切换到拥有者模式，并显示错误消息。即使你尝试编辑，GitHub API 也会拒绝你的请求（因为你没有写权限）。

### Q3: 验证失败后，我的 Token 会被清除吗？

**A**: 不会。Token 仍然保存在本地，你可以重新尝试或切换到访客模式继续浏览。

### Q4: 我可以同时拥有多个 Gist 吗？

**A**: 可以，但系统一次只能关联一个 Gist ID。如果你想切换到另一个 Gist，需要在设置中更改 Gist ID。

## 开发者注意事项

### 测试数据准备

如果你需要测试"非拥有者"场景，可以：

1. 创建两个 GitHub 账号
2. 用账号 A 创建一个 Gist
3. 用账号 B 的 Token 尝试验证账号 A 的 Gist
4. 应该看到验证失败

或者：

1. 使用你的 Token
2. 使用这个公开的测试 Gist ID（如果有的话）
3. 验证应该失败（因为你不是拥有者）

### 代码位置

- **验证方法**：`src/services/gistService.ts` - `verifyGistOwnership()`
- **集成逻辑**：`src/components/mode/ModeSwitcherModal.tsx` - `handleModeSelect()`
- **测试页面**：`src/pages/GistOwnershipTest.tsx`

### 相关文档

- 需求文档：`.kiro/specs/mode-switcher/requirements.md`
- 设计文档：`.kiro/specs/mode-switcher/design.md`
- 任务列表：`.kiro/specs/mode-switcher/tasks.md`

## 总结

这个测试页面帮助你验证：

1. ✅ Token 验证功能正常
2. ✅ Gist 拥有者验证功能正常
3. ✅ 安全机制有效（非拥有者无法切换到拥有者模式）
4. ✅ 边缘情况处理正确（没有 Gist ID 时的行为）
5. ✅ 完整的模式切换流程符合预期

通过这些测试，你可以确信系统能够正确地保护内容，防止未授权的编辑操作。
